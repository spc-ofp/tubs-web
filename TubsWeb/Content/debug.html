<!DOCTYPE html>
<html lang="en">
<head>
    <title>Debugger</title>
    <link href="/Content/toastr.css" rel="stylesheet" type="text/css" />
</head>
<body>
<form id="theForm">
    Is dirty? <span data-bind="text: $root.isDirty"></span>
    <hr />
    <span data-bind="text: $root.day">Didn't work</span>
    <table>
        <thead>
            <tr>
                <th></th>
                <th>
                    Time
                </th>
                <th>
                    Latitude
                </th>
                <th>
                    Longitude
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody data-bind="foreach: $root.events">
            <tr>
                <td>
                    <a href="#" data-bind="click: $root.removeEvent" rel="tooltip" title="Click to remove row">-</a>
                </td>
                <td>
                    <span data-bind="text: time"></span>
                </td>
                <td>
                    <span data-bind="text: latitude"></span>
                </td>
                <td>
                    <span data-bind="text: longitude"></span>
                </td>
                <td>
                    <a href="#" data-bind="click: $root.addEvent" rel="tooltip" title="Click to add row">+</a>
                </td>
            </tr>
        </tbody>
    </table>
    <button data-bind="activity: $root.saveCommand.isExecuting, command: $root.saveCommand">Save</button>
    <button data-bind="enable: $root.isDirty,click: $root.reload">Reload</button>
    </form>
    <script src="/Scripts/jquery-1.8.1.min.js"></script>
    <script src="/Scripts/knockout-2.1.0.js"></script>
    <script src="/Scripts/knockout.mapping-latest.js"></script>
    <script src="/Scripts/knockout.dirtyFlag.js"></script>
    <script src="/Scripts/knockout.asyncCommand.js"></script>
    <script src="/Scripts/knockout.activity.js"></script>
    <script src="/Scripts/toastr.js"></script>
    <script>
        // This is an example of the revealed module design pattern in JavaScript
        // It's a little bit different than the standard implementation in that
        // it's set up to take an argument.
        // Note that the argument name here ('data') matches the
        // argument name for the exported view model ('psSeaDay')
        var vm = function (data) {

            // This mapping is used to override the default
            // JSON mapper for the named property (or properties).
            // In this case, the 'events' property of the mapped JSON
            // object are converted via the anonymous function in
            // 'create'.
            var psSeaDayMapping = {
                'events': {
                    create: function (options) {
                        return new psEvent(options.data);
                    }
                }
            };

            // In this instance, we've augmented the event object with a property
            // that would never come from the JSON object (needsFocus).
            // There might be other reasons to manually map the data
            function psEvent(eventData) {
                var self = this;
                self.time = ko.observable(eventData.time || '');
                self.latitude = ko.observable(eventData.latitude || '');
                self.longitude = ko.observable(eventData.longitude || '');
                self.needsFocus = ko.observable(eventData.needsFocus || false);

                return self;
            };

            // This is the actual Purse Seine Sea Day view model
            // Any functions/properties/etc. that belong on the view model
            // are defined here.
            function psSeaDay(data) {
                var self = this;
                // Map the incoming JSON in 'data' to self, using
                // the options in psSeaDayMapping
                ko.mapping.fromJS(data, psSeaDayMapping, self);

                // Define the fields that are watched to determine the 'dirty' state
                self.dirtyFlag = new ko.DirtyFlag([self.day, self.events]);
                self.isDirty = ko.computed(function () {
                    return self.dirtyFlag().isDirty();
                });

                // Operations
                self.addEvent = function () {
                    self.events.push(new psEvent({ "needsFocus": true }));
                };
                self.removeEvent = function (evt) { self.events.remove(evt); }

                self.reload = function () {
                    self.dirtyFlag().reset();
                }

                self.saveCommand = ko.asyncCommand({
                    execute: function (callback) {
                        $.ajax({
                            // I've got no heartburn with hard-coding this...
                            url: "/Trip/x/Crew/Edit",
                            dataType: "json",
                            contentType: "application/json",
                            data: ko.toJSON(self),
                            type: "POST",
                            success: function (result) {
                                self.dirtyFlag().reset();
                                toastr.success('Daily log saved');
                            },
                            error: function (xhr, status, error) {
                                toastr.error(error, 'Failed to save daily log');
                            },
                            complete: callback
                        })
                    },

                    canExecute: function (isExecuting) {
                        return !isExecuting && self.isDirty();
                    }
                })

                return self;
            };

            // This is how the revealed module pattern publishes
            // a private variable outside the module
            return {
                psSeaDay: psSeaDay
            }
        } ();

        $(document).ready(function () {
            var data = {
                "day": "2011-11-11",
                "events": [
                     { "time": "0100", "latitude": "0130.091S", "longitude": "14557.163E" },
                     { "time": "0200", "latitude": "0131.091S", "longitude": "14657.163E" },
                     { "time": "0300", "latitude": "0132.091S", "longitude": "14757.163E" },
                 ]
            };

            //var vm = new psSeaDay(data);
            var viewModel = new vm.psSeaDay(data);
            ko.applyBindings(viewModel);
        });
    </script>
</body>
</html>
