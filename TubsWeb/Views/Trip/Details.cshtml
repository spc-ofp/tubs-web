@model TubsWeb.ViewModels.TripSummaryViewModel
@using Spc.Ofp.Tubs.DAL.Entities

@* For now, create this in the View. *@
@{
    IEnumerable<Tuple<string, string>> crumbs = new List<Tuple<string, string>>()
    {
        Tuple.Create(Url.RouteUrl("TripList"), "Trips"),
        Tuple.Create("#", Model.SpcTripNumber)
    };
}

@{ Html.RenderPartial("_BreadCrumbs", crumbs); }

@{Html.RenderPartial("_TripSummary");}

@{
    string formatString = System.Web.Configuration.WebConfigurationManager.AppSettings["ReportingServicesFormatUrl"].ToString();
    string baseFileName = ViewBag.BaseDownloadName ?? string.Empty;
}

@* TODO Add downloads for CSV downloads of GEN-1, GEN-2, GEN-6, Days, and Sets *@
@* TODO Better yet, figure out how to push this all into the controller.  This is too messy for Razor *@

@{
    // TODO:  It would be even better if this only showed for people not in the editors group...
    string confirmDownload = "This is confidential data subject to a data disclosure policy.  Continue?";
}

<fieldset>
    <legend><i class="icon-download-alt"></i> Downloads</legend>

    <div class="row">
        <div class="span2"><strong>Cover Page</strong></div>
        @{ 
            string coverPageUrl = String.Format(formatString, "CoverPage", ViewBag.TripId);
            if (!coverPageUrl.EndsWith("&rs:Format=PDF"))
            {
                coverPageUrl += "&rs:Format=PDF";
            }
        }
        <div class="span2">
            <a id="coverPageLink" href="@coverPageUrl" target="_blank" download="@(baseFileName)cover.pdf">
                <img src="~/Content/images/pdf-16x16.png" alt="PDF" height="16" width="16" />&nbsp;PDF
            </a>
        </div>
    </div>
    <div class="row">
        <div class="span2"><strong>Trip Summary</strong></div>
        @{ 
            string reportName =
                "S".Equals(Model.GearCode) ? "PS-TripSummary" :
                "L".Equals(Model.GearCode) ? "LL-TripSummary" :
                "P".Equals(Model.GearCode) ? "PL-TripSummary" :
                String.Empty;
            string tripSummaryUrl = String.Format(formatString, reportName, ViewBag.TripId);
            string externalPdf = tripSummaryUrl + "&rs:Format=PDF";
        }
        <div class="span2">
            <a id="summaryPdf" href="@externalPdf" target="_blank">
                <img src="~/Content/images/pdf-16x16.png" alt="PDF" height="16" width="16" />&nbsp;PDF
            </a>
        </div>
        <div class="span2">
            <a id="summaryOther" href="@tripSummaryUrl">Other Formats</a>
        </div>
    </div>
    <div class="row">
        <div class="span2"><strong>Trip Positions</strong></div>
        <div class="span2">
            @if (!Model.HasPositions)
            {
                @: N/A
            }
            else
            {
            <a id="kmlLink" href='@Url.Action("Positions", "Trip", new { tripId = ViewBag.TripId })' download="@(baseFileName)positions.kml">
                <img src="~/Content/images/google-earth-16x16.png" alt="KML" height="16" width="16" />&nbsp;KML
            </a>
            }
        </div>
        <div class="span2"><a href="#">Other Formats</a></div>
    </div>
    <div class="row">
        <div class="span2"><strong>Length Frequency</strong></div>
        <div class="span2">
            @* TODO:  Change this to N/A if no LF data available *@
            @{ var lflink = Url.RouteUrl(TubsWeb.RouteConfig.LengthFrequencyByTrip, new { tripId = ViewBag.TripId });}
            <a id="lfexcelLink" href="@lflink" download="@(baseFileName)lengthfrequency.xlsx" data-trigger="confirm" data-content="@confirmDownload">
                <img src="~/Content/images/excel-16x16.gif" alt="Excel" height="16" width="16" />&nbsp;Excel
            </a>
        </div>
    </div>
    <div class="row">
        <div class="span2"><strong>Quick Summary</strong></div>
        <div class="span2">
            @* TODO:  Change this to N/A if no LF data available *@
            @{ var tslink = Url.RouteUrl(TubsWeb.RouteConfig.ExcelTripSummary, new { tripId = ViewBag.TripId });}
            <a id="tsexcelLink" href="@tslink" download="@(baseFileName)TripSummary.xlsx">
                <img src="~/Content/images/excel-16x16.gif" alt="Excel" height="16" width="16" />&nbsp;Excel
            </a>
        </div>
    </div>
</fieldset>

@* The following infrastructure moves the trip close form to a Bootstrap modal form *@
<div id="closeModal" class="modal hide fade" tabindex="-1" role="dialog">
    <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="closeModalLabel">Close Trip</h3>
  </div> 
@using (Html.BeginForm("Close", "Trip", FormMethod.Post, new { @class = "form well" }))
{
    <div class="modal-body">
        <p>
            Closing a trip marks the end of data entry. After being closed, the trip will be read only and no further updates will be accepted.
        </p>        
        @Html.HiddenFor(m => Model.Id)
        <label for="Comments">Entry Comments</label>
        <textarea id="Comments" name="Comments" class="span6" rows="2" style="height: 200px;"></textarea>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button type="submit" name="Save" value="Save" class="btn btn-primary">Save</button>
    </div>
}
</div>

<ul id="tlyPageGuide" data-tourtitle="Trip data navigation">
    <li class="tlypageguide_right" data-tourtarget="#subsectionNavbar">
        <div>
            Use these links to navigate to different sections of the trip.
        </div>
    </li>
    <li class="tlypageguide_bottom" data-tourtarget="#crumb_1">
        <div>
            This link will always take you back to the list of all trips.
        </div>
    </li>
    <li class="tlypageguide_bottom" data-tourtarget="#crumb_2">
        <div>
            As you navigate through the different sections, this link will always
            return you to this page.
        </div>
    </li>
    <li class="tlypageguide_left" data-tourtarget="#coverPageLink">
        <div>
            This link will create a PDF coverpage for the trip.
        </div>
    </li>
    <li class="tlypageguide_right" data-tourtarget="#summaryPdf">
        <div>
            This link will create a PDF trip summary report.
            The summary report includes basic catch and effort information.
        </div>
    </li>
    <li class="tlypageguide_right" data-tourtarget="#summaryOther">
        <div>
            This link will take you to the report server.  Use this link if
            you want the summary report in another format like Word, Excel, or CSV.
        </div>
    </li>
    <li class="tlypageguide_bottom" data-tourtarget="#kmlLink">
        <div>
            This link will download a KML file that plots trip positions.
        </div>
    </li>
    <li class="tlypageguide_left" data-tourtarget="#lfexcelLink">
        <div>
            This link will download an Excel file that contains length frequency data for the
            entire trip.
        </div>
    </li>
</ul>

@section Sidebar {

    @{
        IEnumerable<Tuple<string, string>> navpills = ViewBag.NavPills;
        if (null != navpills)
        {
            Html.RenderPartial("_VerticalTripNavBar", navpills);
        }
    }

}

@section AdditionalScripts {
    @* Sco.js integrates with Bootstrap and adds some useful features *@
    @System.Web.Optimization.Scripts.Render("~/bundles/scojs")
    <script>
        $(function () {
            $('.large-text').trunk8({
                fill: '&nbsp;&raquo;&nbsp;'
            });
            /* TODO:  Only execute this if it works in the current browser (read:  Not IE8 or lower) */
            tl.pg.init();
        });
    </script>
}
